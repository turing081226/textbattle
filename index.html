<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TextBattle · 텍스트 배틀</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;--bg2:#0a0f1e;--card:#0e1533c0;--border:#ffffff22;--txt:#e5e7eb;--muted:#93a0b4;
      --accent:#7c3aed;--accent2:#22d3ee;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;--radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35);--blur:12px;--focus:0 0 0 3px color-mix(in oklab, var(--accent) 45%, transparent);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Apple SD Gothic Neo,sans-serif;color:var(--txt);
      background: radial-gradient(1200px 900px at 10% -10%, #1b2659 0, transparent 50%),
                  radial-gradient(1200px 1000px at 110% 0%, #0a5a7a 0, transparent 50%),
                  linear-gradient(180deg, #070b18 0%, #0b1020 60%, #0b1020 100%);background-attachment:fixed}
    .wrap{max-width:1100px;margin:0 auto;padding:28px 14px 44px}

    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 4px 12px rgba(0,0,0,.35)}
    .logo svg{width:24px;height:24px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.25))}
    .title{font-weight:800;letter-spacing:.2px}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#ffffff1a;border:1px solid var(--border)}

    .grid{display:grid;gap:16px;grid-template-columns:repeat(12,minmax(0,1fr))}
    .col-7{grid-column:span 7}.col-5{grid-column:span 5}.col-12{grid-column:span 12}
    @media(max-width:920px){.col-7,.col-5{grid-column:span 12}}

    .card{background:color-mix(in oklab,var(--card) 100%,transparent);backdrop-filter:blur(var(--blur));
      border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card h2{margin:2px 0 10px;font-size:18px;font-weight:800}
    .helper{margin:0 0 12px;color:var(--muted);font-size:13px}

    label{display:block;margin:3px 0 6px;font-size:12px;color:var(--muted)}
    input,select,button,textarea{font:inherit;color:inherit}
    /* 기본 입력 + type 미지정 input 포함 */
    input[type=text],input[type=number],input[type=password],select,textarea,input:not([type]){
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b132b;outline:none;
      transition:.2s box-shadow,.2s border-color}
    input::placeholder{color:#8ea0b3}
    input:focus,select:focus,textarea:focus{box-shadow:var(--focus);border-color:color-mix(in oklab,var(--accent) 40%, var(--border))}
    textarea{height:90px;resize:vertical}

    .row{display:grid;gap:12px;grid-template-columns:repeat(12,minmax(0,1fr));align-items:end}
    .field{grid-column:span 12}.half{grid-column:span 6}
    @media(max-width:720px){.half{grid-column:span 12}}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;user-select:none;
      padding:11px 14px;border-radius:12px;border:1px solid var(--border);
      background:linear-gradient(180deg,color-mix(in oklab,var(--accent) 28%,#151b30 72%),#12172c);
      font-weight:800;letter-spacing:.2px;transition:.15s transform,.2s filter}
    .btn:hover{filter:brightness(1.08)}.btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.secondary{background:#0f172a}

    .pill{border:1px solid var(--border);background:#0d142b;padding:6px 10px;border-radius:999px;font-size:12px}
    .counter{font-size:12px;color:var(--muted)}.counter.warn{color:#ffb4b4}
    .counter-row{display:flex;justify-content:flex-end;margin-top:4px}

    .log{height:240px;background:#090f20;border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto;
      font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;line-height:1.4}

    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    thead th{font-size:12px;text-align:left;color:var(--muted);font-weight:700;background:#0d142b;border-bottom:1px solid var(--border);padding:10px 12px}
    tbody td{padding:12px;border-bottom:1px dashed var(--border)}
    tbody tr:last-child td{border-bottom:none}

    footer{margin-top:22px;color:var(--muted);font-size:12px;display:flex;gap:10px;align-items:center;justify-content:space-between}

    .fade-in{animation:fade .4s ease-out both}@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    /* 오류/링크 */
    .errorbar{background:#1a0e0e;border:1px solid #3b1a1a;color:#ffd6d6;padding:10px 12px;border-radius:10px;margin:12px 0;display:none}
    .linklike{color:var(--accent);text-decoration:none;cursor:pointer}
    .linklike:visited{color:var(--accent)}

    /* admin 캐릭터 생성 성공 메시지 */
    #createMsg{color:var(--txt);}
    .ok{color:var(--good);font-weight:700;}
    .warn{color:var(--warn);font-weight:700;}
    .name-chip{display:inline-block;padding:3px 10px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-weight:800;}
    #meInfo{color:var(--txt);}

    /* 요구: 특정 입력 배경/글자색 조정 */
    #cName, #loginName{
      background:#0d142b !important;      /* 카드와 유사한 네이비 */
      border-color:#1e2a44 !important;
      color:#e7edf6 !important;           /* 높은 대비 */
    }
    #cName::placeholder, #loginName::placeholder{ color:#9fb0c4; }

    /* 요구: 리더보드 캐릭터명 노란색 */
    #lb tbody td:first-child a{
      color:#ffd54a !important; font-weight:700;
    }
    #lb tbody td:first-child a:visited{ color:#ffd54a !important; }
    #lb tbody td:first-child a:hover{ filter:brightness(1.1); }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="fade-in">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M14 6l7-3-3 7-9 9-4 1 1-4 9-9z"/>
            <path d="M10 10l4 4"/>
          </svg>
        </div>
        <div>
          <div class="title">TextBattle</div>
          <div class="helper">텍스트 배틀</div>
        </div>
      </div>
      <span class="badge">beta</span>
    </header>

    <div id="errorBar" class="errorbar" role="alert" aria-live="assertive"></div>

    <div class="grid fade-in" style="animation-delay:.06s">
      <!-- Admin: 캐릭터 만들기 -->
      <section class="card col-12" id="adminBlock" style="display:none;">
        <h2>Admin: 캐릭터 만들기</h2>
        <div class="row">
          <div class="field half">
            <label for="cName">캐릭터 이름</label>
            <input id="cName" type="text" maxlength="24" placeholder="예: 천둥검사">
            <div class="counter-row"><span id="nameCounter" class="counter">0/24</span></div>
          </div>
          <div class="field half">
            <label for="cPass">비밀번호</label>
            <input id="cPass" type="password" placeholder="4자 이상">
          </div>
          <div class="field">
            <label for="cDesc">설정 (100자)</label>
            <textarea id="cDesc" maxlength="100" placeholder="예: 번개를 두른 도검을 휘둘러 빠르게 제압한다."></textarea>
            <div class="counter-row"><span id="descCounter" class="counter">0/100</span></div>
          </div>
          <div class="field" style="display:flex;gap:10px;flex-wrap:wrap">
            <button id="createBtn" class="btn" type="button">생성 & 로그인</button>
            <div id="createMsg" class="helper" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <!-- 로그인 -->
      <section class="card col-12" id="loginBlock">
        <h2>로그인</h2>
        <div class="row">
          <div class="field half">
            <label for="loginName">닉네임</label>
            <input id="loginName" type="text" placeholder="닉네임">
          </div>
          <div class="field half">
            <label for="loginPass">비밀번호</label>
            <input id="loginPass" type="password" placeholder="비밀번호">
          </div>
          <div class="field" style="display:flex;gap:10px;flex-wrap:wrap">
            <button id="loginBtn" class="btn" type="button">로그인</button>
            <button id="logoutBtn" class="btn secondary" type="button">로그아웃</button>
          </div>
          <div class="field"><div id="loginMsg" class="helper" aria-live="polite"></div></div>
        </div>
      </section>

      <!-- 내 전적 + 다음 배틀 -->
      <section class="card col-12" id="meBlock" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <h2 style="margin:0">내 정보</h2>
          <span id="meBadge" class="pill">character</span>
        </div>
        <div id="meInfo" class="helper"></div>
        <div class="row" style="margin-top:8px">
          <div class="field half" style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
            <button id="fightBtn" class="btn" type="button">다음 배틀</button>
            <span id="cooldown" class="helper"></span>
          </div>
          <div class="field"><div id="fightRes"></div></div>
        </div>
      </section>

      <!-- 리더보드 -->
      <section class="card col-12">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <h2 style="margin:0">리더보드</h2>
          <span class="helper">이름을 클릭하면 전적 상세</span>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table id="lb" aria-describedby="리더보드표">
            <thead><tr><th>이름</th><th>ELO</th><th>전적</th><th>설정</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- 캐릭터 전적 상세 -->
      <section class="card col-12" id="detailBlock" style="display:none;">
        <h2 id="detailTitle">전적</h2>
        <div id="detailBody" class="helper">불러오는 중…</div>
      </section>
    </div>

    <footer class="fade-in" style="animation-delay:.1s">
      <span class="helper">© 2025 TextBattle — NEURON</span>
    </footer>
  </div>

  <script>
  // 안전한 유틸
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  // 화면 에러바
  function showError(msg){ const b = $('#errorBar'); if(!b) return; b.textContent = String(msg||''); b.style.display='block'; }
  function hideError(){ const b = $('#errorBar'); if(!b) return; b.textContent=''; b.style.display='none'; }

  // 전역 에러 핸들링: JS 에러가 있어도 버튼이 죽지 않도록 표시
  window.addEventListener('error', e => showError(e.message));
  window.addEventListener('unhandledrejection', e => showError(e.reason?.message || String(e.reason)));

  document.addEventListener('DOMContentLoaded', () => {
    // API 래퍼
    async function api(url, opts = {}){
      // 서버 프리픽스는 /api 로 고정(네가 확인해준 대로)
      if (url.startsWith('/api/')) {
        // 그대로 사용
      } else if (url.startsWith('/')) {
        url = '/api' + url;
      } else {
        url = '/api/' + url.replace(/^\/+/, '');
      }

      if (!('credentials' in opts)) opts.credentials = 'include';
      if (opts.body && typeof opts.body !== 'string') {
        opts.headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
        opts.body = JSON.stringify(opts.body);
      }
      const r = await fetch(url, opts);
      let text = '';
      try { text = await r.text(); } catch {}
      let j; try { j = text ? JSON.parse(text) : {}; } catch { j = {}; }
      if (!r.ok) throw new Error(j?.error || text || '요청 실패');
      return j;
    }

    // 글자수 카운터
    const nameEl = $('#cName'), descEl = $('#cDesc');
    const nameCounter = $('#nameCounter'), descCounter = $('#descCounter');
    function upCounter(el, elC){
      if(!el || !elC) return;
      const max = el.maxLength || 0, len = el.value.length;
      elC.textContent = `${len}/${max}`;
      elC.classList.toggle('warn', max && (max - len) <= 5);
    }
    ['input','change'].forEach(ev=>{
      nameEl?.addEventListener(ev, ()=>upCounter(nameEl, nameCounter));
      descEl?.addEventListener(ev, ()=>upCounter(descEl, descCounter));
    });
    upCounter(nameEl, nameCounter); upCounter(descEl, descCounter);

    // 섹션 참조
    const adminBlock = $('#adminBlock');
    const meBlock = $('#meBlock');
    const meInfo = $('#meInfo');
    const meBadge = $('#meBadge');

    // UI 전환
    async function refreshMe(){
      try{
        const { user, role } = await api('/api/auth/me');
        hideError();
        if (role === 'admin') {
          adminBlock.style.display = '';
          meBlock.style.display = 'none';
          meBadge.textContent = 'admin';
        } else if (role === 'character' && user) {
          adminBlock.style.display = 'none';
          meBlock.style.display = '';
          meBadge.textContent = 'character';
          meInfo.textContent = `#${user.id} ${user.name} — ELO ${user.elo}, ${user.wins}승 ${user.losses}패`;
        } else {
          adminBlock.style.display = 'none';
          meBlock.style.display = 'none';
        }
      }catch(e){ /* 미로그인: 조용히 무시 */ }
    }

    // 리더보드
    async function refreshLB(){
      try{
        const data = await api('/api/leaderboard');
        const tbody = $('#lb tbody'); tbody.innerHTML='';
        data.forEach(c=>{
          const tr = document.createElement('tr');
          const nameTd = document.createElement('td');
          const a = document.createElement('a');
          a.href = '#'; a.textContent = c.name; a.className = 'linklike';
          a.addEventListener('click', (e)=>{ e.preventDefault(); openDetail(c.id); });
          nameTd.appendChild(a);
          tr.appendChild(nameTd);
          tr.innerHTML += `<td>${c.elo}</td><td>${c.wins}승 ${c.losses}패</td><td>${c.description}</td>`;
          tbody.appendChild(tr);
        });
      }catch(e){ showError('리더보드를 불러오지 못했어요: ' + e.message); }
    }

    // 상세 전적
    async function openDetail(id){
      $('#detailBlock').style.display = 'block';
      $('#detailTitle').textContent = '전적';
      $('#detailBody').textContent = '불러오는 중…';
      try{
        const { user, battles } = await api('/api/records?id='+id);
        $('#detailTitle').textContent = `#${user.id} ${user.name} 전적 (${user.wins}승 ${user.losses}패, ELO ${user.elo})`;
        const box = $('#detailBody'); box.innerHTML='';
        if (!battles.length){ box.textContent='전투 기록이 없습니다.'; return; }
        const ul = document.createElement('ul');
        battles.forEach(b=>{
          const opp = (b.a_id===user.id)? {id:b.b_id, name:b.b_name} : {id:b.a_id, name:b.a_name};
          const wl  = (b.winner_id===user.id)? '승' : (b.winner_id==null)? '무' : '패';
          const li = document.createElement('li');
          li.textContent = `[${new Date(b.created_at).toLocaleString()}] vs ${opp.name} → ${wl}`;
          ul.appendChild(li);
        });
        box.appendChild(ul);
      }catch(e){ $('#detailBody').textContent = '전적을 불러오지 못했어요: ' + e.message; }
    }

    // 쿨다운 보조
    const fightBtn = $('#fightBtn'), cdSpan = $('#cooldown'), fightRes = $('#fightRes');
    const CD_KEY = 'battleCooldownUntil';
    function updateCooldownUI(){
      const until = Number(localStorage.getItem(CD_KEY)||'0');
      const remain = Math.ceil((until - Date.now())/1000);
      if (remain > 0) { fightBtn && (fightBtn.disabled = true); cdSpan && (cdSpan.textContent=`쿨다운 ${remain}s`); }
      else { fightBtn && (fightBtn.disabled = false); cdSpan && (cdSpan.textContent=''); }
    }
    setInterval(updateCooldownUI, 500);

    // ==== 버튼 핸들러 (함수화) ====
    async function handleCreate(){
      console.log('[UI] create clicked');
      const name = $('#cName')?.value?.trim();
      const description = $('#cDesc')?.value?.trim();
      const password = $('#cPass')?.value || '';
      const msg = $('#createMsg');
      if (!name || !description || !password){ msg.textContent='이름/설정/비밀번호를 입력하세요.'; return; }
      if (password.length < 4){ msg.textContent='비밀번호는 4자 이상으로 입력하세요.'; return; }
      try{
        const u = await api('/api/characters', { method:'POST', body:{ name, description, password } });
        msg.innerHTML = `<span class="ok">생성 완료:</span> <span class="name-chip">#${u.id} ${u.name}</span> (자동 로그인됨)`;
        $('#cName').value=''; $('#cDesc').value=''; $('#cPass').value='';
        upCounter(nameEl, nameCounter); upCounter(descEl, descCounter);
        await refreshMe(); await refreshLB();
      }catch(e){
        msg.innerHTML = `<span class="warn">생성 실패:</span> ${e.message}`;
        if (String(e.message).includes('admin only')) showError('관리자로 로그인해야 캐릭터를 만들 수 있어요.');
      }
    }

    async function handleLogin(){
      console.log('[UI] login clicked');
      const name = $('#loginName')?.value?.trim();
      const password = $('#loginPass')?.value || '';
      const msg = $('#loginMsg');
      if (!name || !password){ msg.textContent='이름/비밀번호를 입력하세요.'; return; }
      try{
        await api('/api/auth/login', { method:'POST', body:{ name, password } });
        const me = await api('/api/auth/me');
        if (me?.role){
          msg.innerHTML = '<span class="ok">로그인 성공</span>';
          hideError();
          await refreshMe();
        }else{
          showError('로그인 응답은 성공했지만 세션이 확인되지 않았어요.');
        }
      }catch(e){
        msg.innerHTML = '<span class="warn">로그인 실패</span>';
        showError('로그인 실패: ' + e.message);
      }
    }

    async function handleLogout(){
      console.log('[UI] logout clicked');
      await api('/api/auth/logout');
      const msg = $('#loginMsg');
      if (msg) msg.textContent='로그아웃됨';
      await refreshMe();
    }

    async function handleFight(){
      console.log('[UI] fight clicked');
      try{
        if (fightRes) fightRes.textContent='대결 중...';
        const data = await api('/api/fight', { method:'POST' });
        const { A, B, result } = data;
        const winnerName = result.winner==='draw' ? '무승부' : result.winner;
        if (fightRes) fightRes.innerHTML = `
          <p><b>${A.name}</b>(${A.elo}) vs <b>${B.name}</b>(${B.elo})</p>
          <p><b>결과:</b> ${winnerName} 승리!</p>
          <div class="log">${result.log}</div>`;
        localStorage.setItem(CD_KEY, String(Date.now()+60000));
        updateCooldownUI();
        await refreshMe(); await refreshLB();
      }catch(e){
        if (String(e.message).includes('cooldown')){
          if (fightRes) fightRes.innerHTML = `<span class="warn">쿨다운 중입니다. 잠시 후 재시도</span>`;
        }else if (String(e.message).includes('no available opponent')){
          if (fightRes) fightRes.innerHTML = `<span class="warn">더 이상 대전 가능한 상대가 없습니다.</span>`;
        }else if (String(e.message).includes('login required')){
          showError('전투는 캐릭터로 로그인 후 가능합니다.');
        }else{
          showError('전투 중 오류: ' + e.message);
        }
      }
    }

    // ==== 1차: 직접 바인딩 ====
    $('#createBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); handleCreate(); });
    $('#loginBtn')?.addEventListener('click',  (e)=>{ e.preventDefault(); handleLogin();  });
    $('#logoutBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); handleLogout(); });
    $('#fightBtn')?.addEventListener('click',  (e)=>{ e.preventDefault(); handleFight();  });

    // ==== 2차: 델리게이션(백업용) ====
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if (t.closest && t.closest('#createBtn')) { e.preventDefault(); handleCreate(); }
      else if (t.closest && t.closest('#loginBtn')) { e.preventDefault(); handleLogin(); }
      else if (t.closest && t.closest('#logoutBtn')){ e.preventDefault(); handleLogout(); }
      else if (t.closest && t.closest('#fightBtn')) { e.preventDefault(); handleFight(); }
    });

    // 초기 로드
    (async ()=>{
      await refreshMe();
      await refreshLB();
      updateCooldownUI();
      console.log('[UI] init done');
    })();
  }); // DOMContentLoaded
  </script>
</body>
</html>
