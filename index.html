<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>텍스트 배틀 (Vercel)</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 860px; margin: 24px auto; padding: 0 12px; }
    h1 { margin-bottom: 4px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    input, textarea, button, select { font-size: 16px; padding: 8px; }
    textarea { width: 100%; height: 64px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    .log { background: #fafafa; padding: 8px; border-radius: 8px; white-space: pre-wrap; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .counter-row{display:flex;justify-content:flex-end;margin-top:4px}
    .counter{font-size:12px;color:#666}
    .counter.warn{color:#c00;font-weight:600}
  </style>
</head>
<body>
  <h1>텍스트 배틀 (Vercel)</h1>
  <p>캐릭터를 만들고 <b>내 캐릭터 vs 랜덤</b>으로 대결하세요.</p>

  <div class="card">
    <h3>캐릭터 만들기</h3>
    <label>이름
      <input id="name" maxlength="24" placeholder="예: 천둥검사"/>
    </label>
    <div class="counter-row"><span id="nameCounter" class="counter">0/24</span></div>

    <br/>
    <label>설정 (100자)
      <textarea id="desc" maxlength="100"
        placeholder="예: 번개를 두른 도검을 휘둘러 빠르게 제압한다. 비에 젖으면 힘이 강해진다."></textarea>
    </label>
    <div class="counter-row"><span id="descCounter" class="counter">0/100</span></div>

    <br/>
    <button id="create">등록</button>
    <div id="createMsg"></div>
  </div>

  <div class="card">
    <h3>내 캐릭터 vs 랜덤 상대</h3>
    <div class="row">
      <label>내 캐릭터
        <select id="myChar"></select>
      </label>
      <button id="fightMy">대결!</button>
    </div>
    <div id="fightRes"></div>
  </div>

  <div class="card">
    <h3>리더보드 (상위 50)</h3>
    <table id="lb"><thead><tr><th>이름</th><th>ELO</th><th>전적</th><th>설정</th></tr></thead><tbody></tbody></table>
  </div>

  <script>
    // --- 글자수 카운터 ---
    const nameEl = document.getElementById('name');
    const descEl = document.getElementById('desc');
    const nameCounter = document.getElementById('nameCounter');
    const descCounter = document.getElementById('descCounter');
    const createBtn = document.getElementById('create');

    function updateCounter(el, counterEl) {
      const max = el.maxLength > 0 ? el.maxLength : 0;
      const len = el.value.length;
      counterEl.textContent = `${len}/${max}`;
      counterEl.classList.toggle('warn', max && (max - len) <= 5);
    }
    function toggleCreate() {
      createBtn.disabled = !nameEl.value.trim() || !descEl.value.trim();
    }
    ['input','change'].forEach(evt=>{
      nameEl.addEventListener(evt, ()=>{updateCounter(nameEl, nameCounter); toggleCreate();});
      descEl.addEventListener(evt, ()=>{updateCounter(descEl, descCounter); toggleCreate();});
    });
    updateCounter(nameEl, nameCounter); updateCounter(descEl, descCounter); toggleCreate();

    // --- API helpers ---
    async function refreshLB() {
      const r = await fetch('/api/leaderboard');
      const data = await r.json();
      const tbody = document.querySelector('#lb tbody');
      tbody.innerHTML = '';
      data.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.name}</td><td>${c.elo}</td><td>${c.wins}승 ${c.losses}패</td><td>${c.description}</td>`;
        tbody.appendChild(tr);
      });
    }
    async function refreshMySelect() {
      const r = await fetch('/api/characters');
      const data = await r.json();
      const sel = document.querySelector('#myChar');
      sel.innerHTML = '';
      data.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = `#${c.id} ${c.name} (ELO ${c.elo})`;
        sel.appendChild(opt);
      });
    }

    document.getElementById('create').onclick = async () => {
      const name = nameEl.value.trim();
      const description = descEl.value.trim();
      const r = await fetch('/api/characters', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name, description })
      });
      const el = document.getElementById('createMsg');
      if (!r.ok) {
        el.textContent = '등록 실패: ' + (await r.text());
      } else {
        const c = await r.json();
        el.textContent = `등록 완료: #${c.id} ${c.name}`;
        nameEl.value=''; descEl.value='';
        updateCounter(nameEl, nameCounter); updateCounter(descEl, descCounter); toggleCreate();
        await refreshLB(); await refreshMySelect();
      }
    };

    document.getElementById('fightMy').onclick = async () => {
      const my_id = Number(document.querySelector('#myChar').value);
      const res = document.getElementById('fightRes');
      if (!my_id) { res.textContent = '내 캐릭터를 선택하세요.'; return; }
      res.textContent = '대결 중...';
      const r = await fetch('/api/fight', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ my_id })
      });
      const data = await r.json();
      if (!r.ok) { res.textContent = '오류: ' + (data?.error || '요청 실패'); return; }
      const { A, B, result } = data;
      const winnerName = result.winner === 'draw' ? '무승부' : result.winner;
      res.innerHTML = `
        <p><b>${A.name}</b>(${A.elo}) vs <b>${B.name}</b>(${B.elo})</p>
        <p><b>결과:</b> ${winnerName}</p>
        <p><b>해설:</b> ${result.reason}</p>
        <pre class="log">${result.log}</pre>
      `;
      await refreshLB(); await refreshMySelect();
    };

    (async () => { await refreshLB(); await refreshMySelect(); })();
  </script>
</body>
</html>
