<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>í…ìŠ¤íŠ¸ ë°°í‹€</title>
  <style>
    :root {
      --fg: #222;
      --muted: #555;
      --line: #ddd;
      --bg: #f7f9fc; /* ë¶€ë“œëŸ¬ìš´ ë°°ê²½ìƒ‰ */
      --card-bg: #ffffff;
      --accent: #007aff; /* iOS ìŠ¤íƒ€ì¼ ë¸”ë£¨ */
      --accent-hover: #0056b3;
      --warn: #dc3545;
      --ok: #28a745;
      --shadow: 0 4px 12px rgba(0,0,0,0.06);
      --radius-md: 8px;
      --radius-lg: 12px;
      --transition: all 0.2s ease-in-out;
    }
    
    *{ box-sizing:border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      color: var(--fg); 
      background: var(--bg); 
      max-width: 960px; 
      margin: 24px auto; 
      padding: 0 12px; 
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    h1 { margin: 8px 0 24px; font-weight: 700; text-align: center; color: var(--accent); }
    h3 { margin: 0 0 16px; font-weight: 600; }

    .grid { display:grid; grid-template-columns: 1fr; gap: 20px; }
    
    .card { 
      border: 1px solid var(--line); 
      border-radius: var(--radius-lg); 
      padding: 20px; 
      background: var(--card-bg); 
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    .card:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.08); }

    input, textarea, button, select { 
      font: inherit; 
      padding: 10px 12px; 
      border-radius: var(--radius-md);
      transition: var(--transition);
    }
    
    input, textarea, select { 
      border: 1px solid var(--line); 
      width: 100%; 
      background: #fff;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0,123,255,0.15);
      outline: none;
    }
    
    textarea { height: 72px; resize: vertical; }
    
    button { 
      border: 1px solid var(--line); 
      background: #fdfdfd; 
      cursor: pointer; 
      font-weight: 500;
    }
    button:hover { background: #f4f4f4; border-color: #ccc; }
    button:disabled { cursor: not-allowed; opacity: 0.6; }

    /* ì£¼ìš” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    button.btn-primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      font-weight: 600;
    }
    button.btn-primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--line); padding: 12px 8px; text-align: left; }
    th { color: var(--muted); font-weight: 500; font-size: 14px; }
    tbody tr:hover { background: #f7f9fc; }

    .row { display:flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    .row:last-child { margin-bottom: 0; }

    .muted { color:var(--muted); font-size:14px; }
    .right { text-align:right; }
    
    .log { 
      white-space: pre-wrap; 
      background:#f7f9fc; 
      padding: 12px; 
      border-radius: var(--radius-md); 
      border: 1px solid var(--line); 
      font-family: Consolas, "Courier New", monospace;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .warn { color:var(--warn); font-weight:600; }
    .ok { color:var(--ok); font-weight:600; }
    
    .errorbar { 
      background:#fff4f4; 
      border: 1px solid #ffd6d6; 
      color:#a40000; 
      padding: 12px 16px; 
      border-radius: var(--radius-md); 
      margin: 12px 0 20px; 
      display: none; 
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(164,0,0,0.1);
    }
    
    .linklike { color: var(--accent); text-decoration: none; cursor:pointer; font-weight: 500; }
    .linklike:hover { text-decoration: underline; }
    
    .pill { 
      display:inline-block; 
      padding: 4px 10px; 
      border: 1px solid var(--line); 
      border-radius: 999px; 
      font-size: 12px; 
      color: #444; 
      background: #f8f8f8;
    }

    /* ê¸€ììˆ˜ ì¹´ìš´í„° */
    .counter-row { display: flex; justify-content: flex-end; margin-top: 4px; }
    .counter { font-size: 12px; color: #666; }
    .counter.warn { color: var(--warn); font-weight: 600; }
    
    /* ë ˆì´ë¸” ìŠ¤íƒ€ì¼ */
    label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px; }

  </style>
</head>
<body>
  <h1>í…ìŠ¤íŠ¸ ë°°í‹€</h1>

  <div id="errorBar" class="errorbar"></div>

  <div class="grid">
    <div class="card" id="adminBlock" style="display:none;">
      <h3>Admin: ìºë¦­í„° ë§Œë“¤ê¸°</h3>
      <div class="row">
        <label for="cName" style="flex:1 1 260px;">ì´ë¦„
          <input id="cName" maxlength="24" placeholder="ì˜ˆ: ì²œë‘¥ê²€ì‚¬">
        </label>
        <span id="nameCounter" class="muted pill">0/24</span>
      </div>
      <div class="row" style="align-items:flex-start;">
        <label for="cDesc" style="flex:1 1 520px;">ì„¤ì • (100ì)
          <textarea id="cDesc" maxlength="100" placeholder="ì˜ˆ: ë²ˆê°œë¥¼ ë‘ë¥¸ ë„ê²€ì„ íœ˜ë‘˜ëŸ¬ ë¹ ë¥´ê²Œ ì œì••í•œë‹¤. ë¹„ì— ì –ìœ¼ë©´ í˜ì´ ê°•í•´ì§„ë‹¤."></textarea>
        </label>
        <span id="descCounter" class="muted pill">0/100</span>
      </div>
      <div class="row">
        <label for="cPass" style="flex:1 1 260px;">ë¹„ë°€ë²ˆí˜¸
          <input id="cPass" type="password" placeholder="4ì ì´ìƒ">
        </label>
        <button id="createBtn" class="btn-primary" style="align-self: flex-end; padding: 10px 16px;">ìƒì„± & ë¡œê·¸ì¸</button>
      </div>
      <div id="createMsg" class="muted"></div>
    </div>

    <div class="card" id="loginBlock">
      <h3>ë¡œê·¸ì¸</h3>
      <div class="row" style="gap:12px;">
        <label for="loginName" style="flex:1 1 240px;">ì´ë¦„
          <input id="loginName" placeholder="ìºë¦­í„° ì´ë¦„">
        </label>
        <label for="loginPass" style="flex:1 1 240px;">ë¹„ë°€ë²ˆí˜¸
          <input id="loginPass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
        </label>
        <button id="loginBtn" class="btn-primary" style="align-self: flex-end; padding: 10px 16px;">ë¡œê·¸ì¸</button>
        <button id="logoutBtn" style="align-self: flex-end; padding: 10px 16px;">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
      <div id="loginMsg" class="muted"></div>
    </div>

    <div class="card" id="meBlock" style="display:none;">
      <div class="row" style="justify-content:space-between; margin-bottom: 16px;">
        <h3 style="margin:0;">ë‚´ ì •ë³´</h3>
        <span id="meBadge" class="pill">character</span>
      </div>
      <div id="meInfo" class="muted" style="font-size: 16px; margin-bottom: 16px;"></div>
      <div class="row" style="margin-top:8px;">
        <button id="fightBtn" class="btn-primary" style="padding: 10px 16px;">ë‹¤ìŒ ë°°í‹€</button>
        <span id="cooldown" class="muted"></span>
      </div>
      <div id="fightRes" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h3 style="margin:0;">ë¦¬ë”ë³´ë“œ</h3>
        <span class="muted" style="font-size: 13px;">ì´ë¦„ì„ í´ë¦­í•˜ë©´ ì „ì  ìƒì„¸</span>
      </div>
      <table id="lb" style="margin-top: 12px;">
        <thead><tr><th>ì´ë¦„</th><th>ELO</th><th>ì „ì </th><th>ì„¤ì •</th></tr></thead>
        <tbody>
          </tbody>
      </table>
    </div>

    <div class="card" id="detailBlock" style="display:none;">
      <h3 id="detailTitle" style="font-size: 18px;">ì „ì </h3>
      <div id="detailBody" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </div>
  </div>

  <script>
    // =================================================================
    // ğŸŒ ì „ì—­ í—¬í¼ (Global Helpers)
    // =================================================================
    const $ = s => document.querySelector(s);
    const errBar = $('#errorBar');

    function showError(msg) { errBar.textContent = msg; errBar.style.display = 'block'; }
    function hideError() { errBar.style.display = 'none'; errBar.textContent=''; }

    /**
     * API ìš”ì²­ ë˜í¼
     * @param {string} url
     * @param {RequestInit} opts
     */
    async function api(url, opts={}) {
      if (opts.body && typeof opts.body !== 'string') {
        opts.headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
        opts.body = JSON.stringify(opts.body);
      }
      
      let r, j = {};
      try {
        r = await fetch(url, opts);
        j = await r.json();
      } catch (e) {
        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” JSON íŒŒì‹± ì‹¤íŒ¨
        throw new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      if (!r.ok) {
        const m = j?.error || (typeof j === 'string' ? j : 'ì•Œ ìˆ˜ ì—†ëŠ” ìš”ì²­ ì‹¤íŒ¨');
        throw new Error(m);
      }
      return j;
    }

    // =================================================================
    // âœï¸ UI: ê¸€ììˆ˜ ì¹´ìš´í„°
    // =================================================================
    const nameEl = $('#cName'), descEl = $('#cDesc');
    const nameCounter = $('#nameCounter'), descCounter = $('#descCounter');
    
    function upCounter(el, elC) {
      if (!el || !elC) return;
      const max = el.maxLength || 0, len = el.value.length;
      elC.textContent = `${len}/${max}`;
      elC.classList.toggle('warn', max && (max - len) <= 5);
    }
    
    ['input','change'].forEach(ev=>{
      if (nameEl) nameEl.addEventListener(ev, ()=>upCounter(nameEl, nameCounter));
      if (descEl) descEl.addEventListener(ev, ()=>upCounter(descEl, descCounter));
    });
    upCounter(nameEl, nameCounter); upCounter(descEl, descCounter);

    // =================================================================
    // ğŸ† UI: ë¦¬ë”ë³´ë“œ
    // =================================================================
    async function refreshLB() {
      const tbody = $('#lb tbody');
      try {
        const data = await api('/api/leaderboard');
        tbody.innerHTML=''; // ë¹„ìš°ê¸°
        data.forEach(c=>{
          const tr = document.createElement('tr');
          const nameTd = document.createElement('td');
          const a = document.createElement('a');
          a.href='#'; a.textContent=c.name; a.className='linklike';
          a.onclick = (e)=>{ e.preventDefault(); openDetail(c.id); };
          nameTd.appendChild(a);
          tr.appendChild(nameTd);
          
          const eloTd = document.createElement('td');
          eloTd.textContent = c.elo;
          tr.appendChild(eloTd);
          
          const recordTd = document.createElement('td');
          recordTd.textContent = `${c.wins}ìŠ¹ ${c.losses}íŒ¨`;
          tr.appendChild(recordTd);
          
          const descTd = document.createElement('td');
          descTd.textContent = c.description;
          tr.appendChild(descTd);
          
          tbody.appendChild(tr);
        });
      } catch (e) {
        showError('ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”: ' + e.message);
        tbody.innerHTML = '<tr><td colspan="4">ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
      }
    }

    // =================================================================
    // ğŸ“œ UI: ìƒì„¸ ì „ì 
    // =================================================================
    async function openDetail(id) {
      $('#detailBlock').style.display = 'block';
      $('#detailTitle').textContent = 'ì „ì ';
      $('#detailBody').textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
      try {
        const { user, battles } = await api('/api/records?id='+id);
        $('#detailTitle').textContent = `#${user.id} ${user.name} ì „ì  (${user.wins}ìŠ¹ ${user.losses}íŒ¨, ELO ${user.elo})`;
        const box = $('#detailBody'); box.innerHTML='';
        if (!battles.length) { box.textContent = 'ì „íˆ¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }
        
        const ul = document.createElement('ul');
        ul.style.paddingLeft = '20px';
        battles.forEach(b=>{
          const opp = (b.a_id===user.id)? {id:b.b_id, name:b.b_name} : {id:b.a_id, name:b.a_name};
          const wl = (b.winner_id===user.id)? 'ìŠ¹' : (b.winner_id==null)? 'ë¬´' : 'íŒ¨';
          const wlClass = (b.winner_id===user.id)? 'ok' : (b.winner_id==null)? '' : 'warn';
          
          const li = document.createElement('li');
          li.style.marginBottom = '8px';
          li.innerHTML = `[${new Date(b.created_at).toLocaleString()}] vs ${opp.name} â†’ <b class="${wlClass}">${wl}</b>`;
          ul.appendChild(li);
        });
        box.appendChild(ul);
      } catch (e) {
        $('#detailBody').textContent = 'ì „ì ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”: ' : ' + e.message;
      }
    }

    // =================================================================
    // ğŸ‘¤ ì¸ì¦ & ë·° ì „í™˜ (Auth & View Switching)
    // =================================================================
    const adminBlock = $('#adminBlock'), meBlock=$('#meBlock'), meInfo=$('#meInfo'), meBadge=$('#meBadge');
    async function refreshMe() {
      try {
        const { user, role } = await api('/api/auth/me');
        hideError();
        if (role === 'admin') {
          adminBlock.style.display = '';
          meBlock.style.display = 'none';
          meBadge.textContent = 'admin';
        } else if (role === 'character' && user) {
          adminBlock.style.display = 'none';
          meBlock.style.display = '';
          meBadge.textContent = 'character';
          meInfo.textContent = `#${user.id} ${user.name} â€” ELO ${user.elo}, ${user.wins}ìŠ¹ ${user.losses}íŒ¨`;
        } else {
          adminBlock.style.display = 'none';
          meBlock.style.display = 'none';
        }
      } catch (e) {
        // ë¡œê·¸ì¸ ì•ˆë˜ì–´ ìˆì–´ë„ ì—ëŸ¬ëŠ” ë„ìš°ì§€ ì•ŠìŒ (ì˜ë„ëœ ë™ì‘)
        adminBlock.style.display = 'none';
        meBlock.style.display = 'none';
      }
    }

    // =================================================================
    // ğŸ› ï¸ ì´ë²¤íŠ¸: Admin ìºë¦­í„° ìƒì„±
    // =================================================================
    const createBtn = $('#createBtn');
    createBtn?.addEventListener('click', async ()=>{
      const name = $('#cName').value.trim();
      const description = $('#cDesc').value.trim();
      const password = $('#cPass').value;
      const msg = $('#createMsg');
      
      if (!name || !description || !password) { msg.textContent='ì´ë¦„/ì„¤ì •/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
      if (password.length < 4) { msg.textContent='ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.'; return; }
      
      createBtn.disabled = true;
      msg.innerHTML = 'ìƒì„± ì¤‘...';
      try {
        const u = await api('/api/characters', { method:'POST', body:{ name, description, password } });
        msg.innerHTML = `<span class="ok">ìƒì„± ì™„ë£Œ:</span> #${u.id} ${u.name} (ìë™ ë¡œê·¸ì¸ë¨)`;
        $('#cName').value=''; $('#cDesc').value=''; $('#cPass').value='';
        upCounter(nameEl, nameCounter); upCounter(descEl, descCounter);
        await refreshMe(); await refreshLB();
      } catch (e) {
        msg.innerHTML = `<span class="warn">ìƒì„± ì‹¤íŒ¨:</span> ${e.message}`;
        if (e.message.includes('admin only')) showError('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•´ì•¼ ìºë¦­í„°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.');
      } finally {
        createBtn.disabled = false;
      }
    });

    // =================================================================
    // ğŸ”‘ ì´ë²¤íŠ¸: ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ
    // =================================================================
    const loginBtn = $('#loginBtn');
    loginBtn.addEventListener('click', async ()=>{
      const name = $('#loginName').value.trim();
      const password = $('#loginPass').value;
      const msg = $('#loginMsg');
      
      if (!name || !password) { msg.textContent = 'ì´ë¦„/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }
      
      loginBtn.disabled = true;
      msg.innerHTML = 'ë¡œê·¸ì¸ ì¤‘...';
      try {
        await api('/api/auth/login', { method:'POST', body:{ name, password } });
        msg.innerHTML = '<span class="ok">ë¡œê·¸ì¸ ì„±ê³µ</span>';
        hideError();
        $('#loginName').value = '';
        $('#loginPass').value = '';
        await refreshMe();
      } catch (e) {
        msg.innerHTML = '<span class="warn">ë¡œê·¸ì¸ ì‹¤íŒ¨</span>';
        showError('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message);
      } finally {
        loginBtn.disabled = false;
      }
    });
    
    $('#logoutBtn').addEventListener('click', async ()=>{
      try {
        await api('/api/auth/logout');
        $('#loginMsg').textContent = 'ë¡œê·¸ì•„ì›ƒë¨';
      } catch (e) {
        $('#loginMsg').innerHTML = `<span class="warn">ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${e.message}</span>`;
      } finally {
        await refreshMe();
      }
    });

    // =================================================================
    // âš”ï¸ ì´ë²¤íŠ¸: ë°°í‹€ + ì¿¨ë‹¤ìš´
    // =================================================================
    const fightBtn = $('#fightBtn'), cdSpan = $('#cooldown'), fightRes = $('#fightRes');
    const CD_KEY = 'battleCooldownUntil';
    
    function updateCooldownUI() {
      // fightBtnì´ API ìš”ì²­ìœ¼ë¡œ ë¹„í™œì„±í™”ëœ ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´ ì¿¨ë‹¤ìš´ ì²´í¬
      if (!fightBtn.disabled || fightRes.textContent === 'ëŒ€ê²° ì¤‘...') {
        const until = Number(localStorage.getItem(CD_KEY)||'0');
        const remain = Math.ceil((until - Date.now())/1000);
        if (remain > 0) {
          fightBtn.disabled = true;
          cdSpan.textContent = `ì¿¨ë‹¤ìš´ ${remain}s`;
        } else {
          fightBtn.disabled = false;
          cdSpan.textContent = '';
        }
      }
    }
    setInterval(updateCooldownUI, 500);

    fightBtn.addEventListener('click', async ()=>{
      fightBtn.disabled = true; // API ìš”ì²­ ì‹œì‘, ë²„íŠ¼ ë¹„í™œì„±í™”
      try {
        fightRes.textContent = 'ëŒ€ê²° ì¤‘...';
        const data = await api('/api/fight', { method:'POST' });
        const { A, B, result } = data;
        const winnerName = result.winner === 'draw' ? 'ë¬´ìŠ¹ë¶€' : result.winner;
        fightRes.innerHTML = `
          <p style="font-size: 1.1em;"><b>${A.name}</b>(${A.elo}) vs <b>${B.name}</b>(${B.elo})</p>
          <p><b>ê²°ê³¼:</b> ${winnerName} ìŠ¹ë¦¬!</p>
          <div class="log">${result.log}</div>
        `;
        localStorage.setItem(CD_KEY, String(Date.now()+60000));
        await refreshMe(); await refreshLB();
      } catch (e) {
        let errorMsg = 'ì „íˆ¬ ì¤‘ ì˜¤ë¥˜: ' + e.message;
        if (String(e.message).includes('cooldown')) {
          fightRes.innerHTML = `<span class="warn">ì¿¨ë‹¤ìš´ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„</span>`;
        } else if (String(e.message).includes('no available opponent')) {
          fightRes.innerHTML = `<span class="warn">ë” ì´ìƒ ëŒ€ì „ ê°€ëŠ¥í•œ ìƒëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
        } else if (String(e.message).includes('login required')) {
          fightRes.innerHTML = '';
          showError('ì „íˆ¬ëŠ” ìºë¦­í„°ë¡œ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        } else {
          fightRes.innerHTML = '';
          showError('ì „íˆ¬ ì¤‘ ì˜¤ë¥˜: ' + e.message);
        }
      } finally {
        // ì¿¨ë‹¤ìš´ ë¡œì§ì´ ë²„íŠ¼ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ë¯€ë¡œ updateCooldownUI()ë§Œ í˜¸ì¶œ
        updateCooldownUI();
      }
    });

    // =================================================================
    // ğŸš€ ì´ˆê¸°í™” (Initialization)
    // =================================================================
    (async ()=>{
      await refreshMe();
      await refreshLB();
      updateCooldownUI();
    })();
  </script>
</body>
</html>
